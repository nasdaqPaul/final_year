<!DOCTYPE html>
<html>
<head>
    <!--Import Google Icon Font-->
    <title>{{ title or 'Final Year' }}</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="{{ url_for ('.static', filename='css/materialize.css') }}"
          media="screen,projection"/>
    <link type="text/css" rel="stylesheet" href="{{ url_for ('web.static', filename='css/style.css') }}">
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
        .card {
            padding: 5px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .card h5 {
            padding-top: 20px;
        }

    </style>
</head>

<body class="grey">
<header>
    <div class="navbar-fixed">
        <nav class="grey lighten-3">
            <div class="nav-wrapper ">
                <a href="#" class="brand-logo black-text">FinalYear</a>
                <a href="#" data-target="slide-out" class="sidenav-trigger black-text"><i class="material-icons">menu</i></a>
            </div>
        </nav>
    </div>
</header>

<ul id="slide-out" class="sidenav sidenav-fixed invisible grey lighten-3">
    <li>
        <div class="user-view ">
            {#                <div class="background grey">#}
            {#                  <img src="https://picsum.photos/seed/picsum/200/300">#}
            {#                </div>#}
            <a href="#user"><img class="circle" src="https://picsum.photos/id/237/200/300"></a>
            <a href="#name"><span
                    class="name">{{ current_user.first_name + " " + current_user.last_name }}</span></a>
            {#                <p>{{ current_user.department.name }}<br/><span class="red-text">{{ current_user.role }}</span></p>#}
        </div>
    </li>
    <li>
        <div class="divider"></div>
    </li>
    <li><a class="subheader">Actions</a></li>

    <li><a href="/create_event"><i class="material-icons">event</i>Create new event</a></li>
    <li class="active"><a href="/create_announcement"><i class="material-icons">announcement</i>Create new
        announcement</a></li>
    <li>
        <div class="divider"></div>
    </li>
    <li><a class="subheader">Your account</a></li>
    <li ><a class="waves-effect red-text text-darken-4" href="#!">Log Out</a></li>

</ul>

<main>
<h1 class="center">Select Recipients</h1>
    {% for permitted_course in permitted_courses %}
        <div class="card rounded ">
            <!-- Card fixed navbar -->
            <div>
                <nav class="nav-extended light-blue">
                    <div class="nav-wrapper">
                        <h5 class="center">{{ permitted_course.course.name }}</h5>
                    </div>
                    <div class="nav-content">
                        <ul class="tabs tabs-transparent">
                            <li class="tab col s3"><a class="active"
                                                      href="#express_{{ permitted_course.course.course_code }}">Express</a>
                            </li>
                            <li class="tab col s3"><a id="custom_tab_button_{{ permitted_course.course.course_code }}"
                                                      href="#custom_{{ permitted_course.course.course_code }}">Custom</a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>

            <!-- Express Tab -->
            <div id="express_{{ permitted_course.course.course_code }}" class="col s12">
                <div class="row">
                    <p>
                        <label>
                            <input type="checkbox" id="all_at_{{ permitted_course.course.course_code }}"/>
                            <span>All levels</span>
                            <hr>
                        </label>
                    </p>
                </div>

                <div class="row">
                    <div class="col s3">
                        <p>
                            <label>
                                <input id='one_at_{{ permitted_course.course.course_code }}' type="checkbox"/>
                                <span>First Years</span>
                            </label>
                        </p>
                    </div>
                    <div class="col s3">
                        <p>
                            <label>
                                <input id='two_at_{{ permitted_course.course.course_code }}' type="checkbox"/>
                                <span>Second Years</span>
                            </label>
                        </p>
                    </div>
                    <div class="col s3">
                        <p>
                            <label>
                                <input id='three_at_{{ permitted_course.course.course_code }}' type="checkbox"/>
                                <span>Third Years</span>
                            </label>
                        </p>
                    </div>
                    <div class="col s3">
                        <p>
                            <label>
                                <input id='four_at_{{ permitted_course.course.course_code }}' type="checkbox"/>
                                <span>Forth Years</span>
                            </label>
                        </p>
                    </div>

                </div>
            </div>

            <!-- Custom Tab -->
            <div id="custom_{{ permitted_course.course.course_code }}" class="col s12 rd">
                <table id="custom_table_{{ permitted_course.course.course_code }}" class="hide">
                    <thead>
                    <tr>
                        <th>Admission Number</th>
                        <th>Student Name</th>
                        <th>Select Student</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <div id="custom_loader_{{ permitted_course.course.course_code }}">
                    <p>Please wait while we query the database....</p>
                    <div class="preloader-wrapper big active center-align">
                        <div class="spinner-layer spinner-blue">
                            <div class="circle-clipper left">
                                <div class="circle"></div>
                            </div>
                            <div class="gap-patch">
                                <div class="circle"></div>
                            </div>
                            <div class="circle-clipper right">
                                <div class="circle"></div>
                            </div>
                        </div>

                        <div class="spinner-layer spinner-red">
                            <div class="circle-clipper left">
                                <div class="circle"></div>
                            </div>
                            <div class="gap-patch">
                                <div class="circle"></div>
                            </div>
                            <div class="circle-clipper right">
                                <div class="circle"></div>
                            </div>
                        </div>

                        <div class="spinner-layer spinner-yellow">
                            <div class="circle-clipper left">
                                <div class="circle"></div>
                            </div>
                            <div class="gap-patch">
                                <div class="circle"></div>
                            </div>
                            <div class="circle-clipper right">
                                <div class="circle"></div>
                            </div>
                        </div>

                        <div class="spinner-layer spinner-green">
                            <div class="circle-clipper left">
                                <div class="circle"></div>
                            </div>
                            <div class="gap-patch">
                                <div class="circle"></div>
                            </div>
                            <div class="circle-clipper right">
                                <div class="circle"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
    <footer class="page-footer z-depth-5 white">
        <ul class="pagination center">
            <li class=""><a href="/create_announcement"><i class="material-icons">chevron_left</i></a></li>
            <li class=""><a href="/create_announcement">Edit</a></li>
            <li class="active" id="rep"><a href="#">Recipients</a></li>
            <li class="waves-effect"><a id="send" href="/announcement_preview">Send</a></li>
            <li class="waves-effect"><a href="#!"><i class="material-icons">chevron_right</i></a></li>
        </ul>
        <div class="footer-copyright">
            <div class=" black-text">
                Â© 2020 Copyright Text
                <a class="grey-text text-lighten-4 right" href="#!">More Links</a>
            </div>
        </div>
    </footer>
</main>

<!--JavaScript at end of body for optimized loading-->
<script type="text/javascript" src="{{ url_for('.static', filename='js/jQuery.js') }}"></script>
<script type="text/javascript" src="{{ url_for('.static', filename='js/materialize.js') }}"></script>
<script>
    $(document).ready(function () {
        $('.tabs').tabs();
        $('.sidenav').sidenav();

        const custom_students = [];
        const express = {};

        {% for pc in permitted_courses %}
            const custom_tab_button_{{ pc.course.course_code }} = $('#custom_tab_button_{{ pc.course.course_code }}');
            const all_at_{{ pc.course.course_code }} = $('#all_at_{{pc.course.course_code }}');
            const one_at_{{ pc.course.course_code }} = $('#one_at_{{ pc.course.course_code }}');
            const two_at_{{ pc.course.course_code }} = $('#two_at_{{ pc.course.course_code }}');
            const three_at_{{ pc.course.course_code }} = $('#three_at_{{ pc.course.course_code }}');
            const four_at_{{ pc.course.course_code }} = $('#four_at_{{ pc.course.course_code }}');

            express['{{ pc.course.course_code }}'] = [];

            all_at_{{ pc.course.course_code }}.on('click', function () {
                // Check self for true or false
                if ($(this).prop('checked')) {
                    one_at_{{ pc.course.course_code }}.prop('checked', true);
                    two_at_{{ pc.course.course_code }}.prop('checked', true);
                    three_at_{{ pc.course.course_code }}.prop('checked', true);
                    four_at_{{ pc.course.course_code }}.prop('checked', true);
                    express['{{ pc.course.course_code }}'] = [1, 2, 3, 4]
                } else {
                    one_at_{{ pc.course.course_code }}.prop('checked', false);
                    two_at_{{ pc.course.course_code }}.prop('checked', false);
                    three_at_{{ pc.course.course_code }}.prop('checked', false);
                    four_at_{{ pc.course.course_code }}.prop('checked', false);
                    express['{{ pc.course.course_code }}'] = [];
                }

            });
            one_at_{{ pc.course.course_code }}.on('click', function () {
                if (all_at_{{ pc.course.course_code }}.prop('checked')) {
                    all_at_{{ pc.course.course_code }}.prop('checked', false);
                }
                if ($(this).prop('checked')) {
                    express['{{ pc.course.course_code }}'].push(1);
                } else {
                    express['{{ pc.course.course_code }}'].splice(express['{{ pc.course.course_code }}'].indexOf(1), 1);
                }
            });
            two_at_{{ pc.course.course_code }}.on('click', function () {
                if (all_at_{{ pc.course.course_code }}.prop('checked')) {
                    all_at_{{ pc.course.course_code }}.prop('checked', false);
                }
                if ($(this).prop('checked')) {
                    express['{{ pc.course.course_code }}'].push(2);
                } else {
                    express['{{ pc.course.course_code }}'].splice(express['{{ pc.course.course_code }}'].indexOf(2), 1);
                }
            });
            three_at_{{ pc.course.course_code }}.on('click', function () {
                if (all_at_{{ pc.course.course_code }}.prop('checked')) {
                    all_at_{{ pc.course.course_code }}.prop('checked', false);
                }
                if ($(this).prop('checked')) {
                    express['{{ pc.course.course_code }}'].push(3);
                } else {
                    express['{{ pc.course.course_code }}'].splice(express['{{ pc.course.course_code }}'].indexOf(3), 1);
                }
            });
            four_at_{{ pc.course.course_code }}.on('click', function () {
                if (all_at_{{ pc.course.course_code }}.prop('checked')) {
                    all_at_{{ pc.course.course_code }}.prop('checked', false);
                }
                if ($(this).prop('checked')) {
                    express['{{ pc.course.course_code }}'].push(4);
                } else {
                    express['{{ pc.course.course_code }}'].splice(express['{{ pc.course.course_code }}'].indexOf(4), 1);
                }
            });

            custom_tab_button_{{ pc.course.course_code }}.one('click', function () {
                $.getJSON('/get_students', {course_code: '{{ pc.course.course_code }}'}, function (data) {
                    const table_body = $('#custom_table_{{ pc.course.course_code }}');
                    data.forEach(function (student, index) {
                        table_body.find($('tbody')).append(`<tr><td>${student.adm_number}</td><td>${student.name}</td><td><label>
                        <input type="checkbox" class="filled-in custom_student" value="${student.adm_number}"/>
                        <span></span>
                        </label></td></tr>`);
                    });
                    table_body.removeClass('hide');
                    $('#custom_loader_{{ pc.course.course_code }}').addClass('hide');
                    $('#custom_{{ pc.course.course_code }} .custom_student').on('click', function () {
                        if ($(this).prop('checked')) {
                            custom_students.push($(this).attr('value'));
                            console.log(custom_students);
                        } else {
                            custom_students.splice(custom_students.indexOf($(this).attr('value')), 1);
                            console.log(custom_students);
                        }
                    })
                });
            });
        {% endfor %}
        $('#send').on('click', function (e) {
            let not_empty_express = false;
            Object.keys(express).forEach(function (course) {
                if (express[course].length !== 0) {
                    not_empty_express = true;
                }
            });
            if (custom_students.length !== 0 || not_empty_express) {
                // Send data to server
                $.ajax({
                    url: '/save_announcement_rc',
                    type: 'POST',
                    data: JSON.stringify({custom_students, express}),
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    async: true,
                    success: function (msg) {
                        console.log(msg);
                    }
                })
                return;
            }

            M.toast({
                html: "Recipients cannot be empty"
            });
            e.preventDefault();
        });
    });
</script>

</body>
</html>